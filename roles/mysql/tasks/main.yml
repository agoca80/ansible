---
# mysql/tasks/main.yml

- name: start service
  service:
    name: mysql-server
    state: started

# This is required by mysql_db and mysql_user
- name: ansible dependencies
  package:
    name: py37-pymysql-0.10.0
    state: present

- name: Create databases
  loop: "{{ mysql_databases }}"
  mysql_db:
    login_unix_socket: /var/run/mysql/mysql.sock
    name: "{{ item }}"
    state: present

- name: Create users with all database privileges
  loop_control:
    label: "{{ item.user }}"
  loop: "{{ mysql_users }}"
  mysql_user:
    login_unix_socket: /var/run/mysql/mysql.sock
    name: "{{ item.user }}"
    host: "%"
    password: "{{ lookup('hashi_vault', 'secret=kv/mysql/{{ item.user }}')['password'] }}"
    priv: '{{ item.database }}.*:ALL'
    state: present
